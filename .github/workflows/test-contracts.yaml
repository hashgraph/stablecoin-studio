name: Test_Contracts

on:
  pull_request:
    paths:
      - "contracts/contracts/**"
      - "contracts/test/**"
      - "contracts/scripts/**"
      - "package*.json"
      - "contracts/hardhat.config.ts"
      - "contracts/tsconfig.json"
      - "contracts/.solcover.js"
  push:
    branches:
      - main

jobs:
  test-contracts:
    name: Test Stablecoin Studio Contracts
    runs-on: token-studio-linux-medium
    #timeout-minutes: 10
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Restore dependencies from cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            */*/node_modules
            */*/*/node_modules
            ~/.npm
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Cache Hardhat artifacts
        uses: actions/cache@v4
        with:
          path: |
            contracts/artifacts
            contracts/cache
            contracts/typechain-types
          # Include package-lock.json in key to invalidate cache when dependencies change
          key: ${{ runner.os }}-hardhat-${{ hashFiles('**/package-lock.json', 'contracts/**/*.sol') }}
          restore-keys: |
            ${{ runner.os }}-hardhat-

      - name: Compile contracts
        run: |
          echo "ðŸ”¨ Compiling Stablecoin Studio contracts..."
          npm run build:contracts          
          echo "âœ… Contracts compiled successfully"

      - name: Run tests with coverage
        run: |
          echo "ðŸ§ª Running tests with coverage for Stablecoin Studio contracts..."
          npm run coverage:contracts
